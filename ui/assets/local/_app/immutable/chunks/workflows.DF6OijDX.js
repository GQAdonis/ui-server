import{d as m,r as at,w as x}from"./entry.54u1u32D.js";import{p as y}from"./stores.RwfRkyB4.js";import{t as b}from"./translate.BBe5dcco.js";import{v as Q,C as h}from"./scheduler.DZa-jdu7.js";import{r as w,a as d,i as U,c as st,p as it,d as ct,e as ut,f as lt,m as L}from"./route-for-api.X9I49Tu1.js";import{A as p}from"./workflow-actions.DQsaZrPA.js";import{b as ft,c as dt}from"./decode-payload.CRQUck_K.js";import{f as wt,g as mt,h as kt}from"./screaming-enums.w0zEi9dM.js";import{s as ht,c as j,t as T}from"./versions.C9LhOlnP.js";import{s as yt}from"./index.DU9o1DRU.js";import{a as S}from"./auth-user.BJCwEhz3.js";import{c as Et}from"./events.CDzmPZGc.js";import{e as K,s as gt}from"./encode-payload.nyvnYrYS.js";import{s as I}from"./parse-with-big-int.BKSBwM2t.js";import{i as xt,c as bt,d as z,e as pt}from"./format-time.DYlkplr6.js";import{a as It}from"./events-service.AptH0gQH.js";import{v as Wt}from"./toaster.C9w9FNzR.js";const Tt=async(t,o,n=fetch)=>{let e=0;try{const r=w("workflows.count",{namespace:t}),a=await d(r,{params:o?{query:o}:{},onError:Q,handleError:Q,request:n});e=parseInt((a==null?void 0:a.count)||"0")}catch{}return{count:e}},bo=async({namespace:t,query:o})=>{const n="GROUP BY ExecutionStatus",e=w("workflows.count",{namespace:t}),{count:r,groups:a}=await d(e,{params:{query:o?`${o} ${n}`:`${n}`},notifyOnError:!1});return{count:r??"0",groups:a}},po=async({namespace:t})=>{const o='TemporalNamespaceDivision="TemporalScheduler" AND ExecutionStatus="Running"',n=w("workflows.count",{namespace:t}),{count:e}=await d(n,{params:{query:o},notifyOnError:!1});return e??"0"},St=(t=ht)=>!h(t).disableWriteActions,At=(t=[])=>t.map(o=>{const n=yt(o,!0),e=o.activityId;return{...n,id:e}}),Ct=t=>t?t.map(o=>({...o,state:mt(o.state)})):[],Pt=t=>t?t.map(o=>({...o,state:kt(o.state)})):[],Rt=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((n,[e,r])=>({...n,[e]:ft(r)}),{})},A=t=>{var v,$,N,B,F,V,q,D;const o=Rt(t.workflowExecutionInfo.searchAttributes),n=t.workflowExecutionInfo.memo,e=t.workflowExecutionInfo.type.name,r=t.workflowExecutionInfo.execution.workflowId,a=t.workflowExecutionInfo.execution.runId,i=t.workflowExecutionInfo.startTime,s=t.workflowExecutionInfo.closeTime,c=t.workflowExecutionInfo.executionTime,l=wt(t.workflowExecutionInfo.status),f=l==="Running",k=t.workflowExecutionInfo.historyLength,u=t.workflowExecutionInfo.historySizeBytes,E=`/workflows/${r}/${a}`,g=(($=(v=t==null?void 0:t.executionConfig)==null?void 0:v.taskQueue)==null?void 0:$.name)||((N=t==null?void 0:t.workflowExecutionInfo)==null?void 0:N.taskQueue),O=(B=t==null?void 0:t.workflowExecutionInfo)==null?void 0:B.mostRecentWorkerVersionStamp,H=(F=t==null?void 0:t.workflowExecutionInfo)==null?void 0:F.assignedBuildId,J=(V=t==null?void 0:t.workflowExecutionInfo)==null?void 0:V.parentNamespaceId,M=(q=t==null?void 0:t.workflowExecutionInfo)==null?void 0:q.parentExecution,X=t.workflowExecutionInfo.stateTransitionCount,Z=(D=t.executionConfig)==null?void 0:D.defaultWorkflowTaskTimeout,tt=At(t.pendingActivities),ot=(t==null?void 0:t.pendingChildren)??[],nt=Ct(t==null?void 0:t.pendingNexusOperations),et=t==null?void 0:t.pendingWorkflowTask,rt=Pt(t==null?void 0:t.callbacks);return{name:e,id:r,runId:a,startTime:i,endTime:s,executionTime:c,status:l,historyEvents:k,historySizeBytes:u,searchAttributes:o,memo:n,url:E,taskQueue:g,assignedBuildId:H,mostRecentWorkerVersionStamp:O,pendingActivities:tt,pendingChildren:ot,pendingNexusOperations:nt,pendingWorkflowTask:et,callbacks:rt,parentNamespaceId:J,parent:M,stateTransitionCount:X,isRunning:f,defaultWorkflowTaskTimeout:Z,get canBeTerminated(){return f&&St()}}},C=t=>(t.executions||[]).map(o=>A({workflowExecutionInfo:o})),Ot=(t,o)=>{var n;return((n=t==null?void 0:t.visibilityStore)==null?void 0:n.includes("elasticsearch"))||U(o,"1.19")},vt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},P=m([y],([t])=>{var o,n,e;return(e=(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:e.isCloud}),G=m([j,T,P],([t,o,n])=>Ot(t,o)||n);m([j,P],([t,o])=>vt(t)||o);const $t={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Nt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Bt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Ft=t=>{if(typeof t!="string")return!1;for(const o of Nt)if(o===t)return!0;return!1},Vt=(t,o,n)=>{const e=$t[t];return o==="All"?"":xt(o)||bt(o)?n||h(G)?`${e} > "${z(o)}"`:`${e} BETWEEN "${z(o)}" AND "${pt()}"`:`${e}="${o}"`},qt=(t,o)=>Object.entries(t).map(([n,e])=>{if(Ft(n)&&Bt(e))return Vt(n,e,o)}).filter(Boolean),Dt=(t,o=!1)=>qt(t,o).join(" and ");function Qt(t){console.error("Unhandled action:",t)}const zt=(t,o)=>{let n;switch(t){case p.Cancel:n=b("workflows.canceled");break;case p.Reset:n=b("workflows.reset");break;case p.Terminate:n=b("workflows.terminated");break;default:Qt(t)}return o?b("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:o}):b("workflows.workflow-action-reason-placeholder",{action:n})},_=({action:t,reason:o,email:n})=>{const e=zt(t,n);return o?[o.trim(),e].join(" "):e},R=async(t,o,n=fetch,e=!1)=>{const r=o.query||Dt(o,e);let a;try{a=decodeURIComponent(r)}catch{a=r}const i=e?"workflows.archived":"workflows";let s="";const c=u=>{var E,g;ct(u),(E=u==null?void 0:u.body)!=null&&E.message||u!=null&&u.status?s=((g=u==null?void 0:u.body)==null?void 0:g.message)??`Error fetching workflows: ${u.status}: ${u.statusText}`:s="Error fetching workflows: Server failed to respond"},l=w(i,{namespace:t}),{executions:f,nextPageToken:k}=await d(l,{params:{query:a},onError:c,handleError:c,request:n})??{executions:[],nextPageToken:""};return{workflows:C({executions:f}),nextPageToken:String(k),error:s}},Io=async({namespace:t,workflowId:o,url:n},e=fetch)=>{var f;const r="workflows",a=n??st(t),i=it(r,{namespace:t}),s=a+i,{executions:c}=await d(s,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:e})??{executions:[]},l=(f=C({executions:c}))==null?void 0:f[0];return{runId:l==null?void 0:l.runId}},Wo=async(t,o=fetch,n=!1)=>{const e=n?"workflows.archived":"workflows";let r=!0;const a=s=>{(ut(s)||lt(s))&&(r=!1)},i=w(e,{namespace:t});return await d(i,{params:{pageSize:"1"},onError:a,handleError:a,request:o}),{authorized:r}},To=async(t,o,n=fetch)=>R(t,o,n,!0);async function So(t,o=fetch){const n=w("workflow",{namespace:t.namespace,workflowId:t.workflowId});return d(n,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(e=>({workflow:A(e)})).catch(e=>({error:e}))}async function Ao({workflow:t,namespace:o,reason:n}){const e=w("workflow.terminate",{namespace:o,workflowId:t.id}),r=h(S).email,a=_({reason:n,action:p.Terminate,email:r});return await d(e,{options:{method:"POST",body:I({reason:a,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Co({namespace:t,workflow:{id:o,runId:n}},e=fetch){const r=w("workflow.cancel",{namespace:t,workflowId:o});return d(r,{request:e,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Po({namespace:t,workflow:{id:o,runId:n},name:e,input:r}){const a=w("workflow.signal",{namespace:t,workflowId:o,signalName:e}),i=await K(r),s=h(y).data.settings,c=(s==null?void 0:s.version)??"",f=U(c,"2.22")?{signalName:e,workflowExecution:{workflowId:o,runId:n},input:{payloads:i}}:{signalName:e,input:{payloads:i},params:{"execution.runId":n}};return d(a,{notifyOnError:!1,options:{method:"POST",body:I(f)}})}async function Ro({namespace:t,workflow:{id:o,runId:n},eventId:e,reason:r,reapplyType:a}){const i=w("workflow.reset",{namespace:t,workflowId:o}),s=h(S).email,c=_({action:p.Reset,reason:r,email:s}),l={workflowExecution:{workflowId:o,runId:n},workflowTaskFinishEventId:e,resetReapplyType:a,requestId:Wt(),reason:c};return d(i,{notifyOnError:!1,options:{method:"POST",body:I(l)},params:{"execution.runId":n}})}async function Oo(t,o=fetch){const n=r=>{console.error(r)},e=w("workflow",t);return d(e,{request:o,onError:n,handleError:n}).then(A)}async function vo(t,o,n){if(!h(Y))return[];try{let e=`ParentWorkflowId = "${o}"`;n&&(e+=` AND ParentRunId = "${n}"`);const{workflows:r}=await R(t,{query:e});return r}catch{return[]}}const Ut=t=>{if(!t.length)return{};const o={};return t.forEach(n=>{o[n.attribute]=gt(n.value)}),o};async function $o({namespace:t,workflowId:o,taskQueue:n,workflowType:e,input:r,searchAttributes:a}){const i=w("workflow",{namespace:t,workflowId:o});let s;if(r)try{s=await K(r)}catch{console.error("Could not decode input for starting workflow")}const c=I({workflowId:o,taskQueue:{name:n},workflowType:{name:e},input:s?{payloads:s}:null,searchAttributes:a.length===0?null:{indexedFields:{...Ut(a)}}});return d(i,{notifyOnError:!1,options:{method:"POST",body:c}})}const No=async({namespace:t,workflowType:o,workflowId:n})=>{var a,i,s;const e=c=>{console.error(c)},r={input:"",searchAttributes:void 0};try{let c="";o&&n?c=`WorkflowType = "${o}" AND WorkflowId = "${n}"`:o?c=`WorkflowType = "${o}"`:n&&(c=`WorkflowId = "${n}"`);const l=w("workflows",{namespace:t}),f=await d(l,{params:{query:c,pageSize:"1"},handleError:e});if(!((a=f==null?void 0:f.executions)!=null&&a[0]))return r;const k=C(f)[0],E=await It({namespace:t,workflowId:k.id,runId:k.runId}),g=await dt((i=E==null?void 0:E.attributes)==null?void 0:i.input,t,h(y).data.settings,h(S).accessToken);return{input:I(g==null?void 0:g.payloads[0]),searchAttributes:(s=k==null?void 0:k.searchAttributes)==null?void 0:s.indexedFields}}catch{return r}},Lt=300,jt=async(t,o,n)=>{o.set(!0);try{await n()}catch(e){console.error(e)}t.set(!1),setTimeout(()=>{o.set(!1)},Lt)},Kt=m([y],([t])=>{var o,n,e;return!!((e=(n=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:n.capabilities)!=null&&e.countGroupByExecutionStatus)}),Bo=m([y,T],([t,o])=>{var r,a,i;const n=L("1.23.0",o),e=!!((i=(a=(r=t.data)==null?void 0:r.systemInfo)==null?void 0:a.capabilities)!=null&&i.prefixSearch);return n||e}),Gt=x(0),_t=m([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.hideWorkflowQueryErrors}),Fo=m([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.refreshWorkflowCountsDisabled}),Y=m([P,T],([t,o])=>t||L("1.23.0",o)),Yt=m([y],([t])=>t.url.searchParams.get("query")),Ht=m([Yt,Y,Et],([t,o,n])=>o&&!n?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),Jt=m([y],([t])=>t.params.namespace),Mt=m([Jt,Ht,Gt,G,_t],([t,o,n,e,r])=>({namespace:t,query:o,refresh:n,supportsAdvancedVisibility:e,hideWorkflowQueryErrors:r})),Xt=t=>{no.set({...t,newCount:0})},Zt=t=>Mt.subscribe(({namespace:o,query:n,supportsAdvancedVisibility:e,hideWorkflowQueryErrors:r})=>{jt(oo,to,async()=>{const{workflows:a,error:i}=await R(o,{query:n});if(t(a),e&&!h(Kt)){const s=await Tt(o,n);Xt(s)}i?r?W.set(b("workflows.workflows-error-querying")):W.set(i):W.set("")})}),Vo=x(""),to=x(!0),oo=x(!0),no=x({count:0,newCount:0}),W=x(""),qo=at([],Zt),Do=x("");export{Do as A,zt as B,Y as C,qo as D,oo as E,to as F,W as G,Wo as a,bo as b,Co as c,Fo as d,Vo as e,Io as f,No as g,$o as h,G as i,vo as j,po as k,P as l,St as m,To as n,Dt as o,Ro as p,Ht as q,Gt as r,Ut as s,Ao as t,Po as u,So as v,no as w,Oo as x,Kt as y,Bo as z};
