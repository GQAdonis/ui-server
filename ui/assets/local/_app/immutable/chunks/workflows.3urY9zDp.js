import{d as y,r as ut,w as p}from"./entry.zWs7fgRK.js";import{p as E}from"./stores.V0Get6qo.js";import{t as I}from"./translate.HrioCK44.js";import{b as lt}from"./workflow-counts.TsEsUQ7a.js";import{H as g}from"./scheduler._Ej0PSBZ.js";import{A as b}from"./workflow-actions.-K4W_iAA.js";import{b as ft,c as dt}from"./decode-payload.NYsLjwkk.js";import{f as wt,g as mt,h as ht}from"./screaming-enums.6mdiatB1.js";import{w as kt}from"./write-actions-are-allowed.s7HYX1ux.js";import{s as yt,t as C}from"./index.7JO8TAz4.js";import{a as P}from"./auth-user.PBx4MCro.js";import{i as _,r as m,a as w,c as gt,p as Et,d as pt,e as xt,f as It,m as G}from"./route-for-api.xYa66Tv6.js";import{c as J,t as R}from"./versions.bQkM0_Rw.js";import{f as H,s as bt}from"./events.LytFebJm.js";import{e as M,s as vt}from"./encode-payload.QypGSoA5.js";import{s as v}from"./parse-with-big-int.jPY5aC0s.js";import{k as Wt,l as Tt,m as K,n as At}from"./format-time.8UcGlNKX.js";import{r as X}from"./workflow-run.P7Jfbeut.js";import{m as St}from"./has.BboW8cQC.js";import{p as Y}from"./paginated.Kf1xK15K.js";import{v as Ct}from"./toaster.OGgsvUb6.js";const Pt=(t=[])=>t.map(o=>{const e=yt(o,!0),n=o.activityId;return{...e,id:n}}),Rt=t=>t?t.map(o=>({...o,state:mt(o.state)})):[],Nt=t=>t?t.map(o=>({...o,state:ht(o.state)})):[],Ft=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((e,[n,r])=>({...e,[n]:ft(r)}),{})},N=t=>{var V,B,Q,z,D,U,L,j;const o=Ft(t.workflowExecutionInfo.searchAttributes),e=t.workflowExecutionInfo.memo,n=t.workflowExecutionInfo.type.name,r=t.workflowExecutionInfo.execution.workflowId,a=t.workflowExecutionInfo.execution.runId,s=t.workflowExecutionInfo.startTime,i=t.workflowExecutionInfo.closeTime,c=t.workflowExecutionInfo.executionTime,l=wt(t.workflowExecutionInfo.status),u=l==="Running",d=t.workflowExecutionInfo.historyLength,f=t.workflowExecutionInfo.historySizeBytes,h=`/workflows/${r}/${a}`,k=((B=(V=t==null?void 0:t.executionConfig)==null?void 0:V.taskQueue)==null?void 0:B.name)||((Q=t==null?void 0:t.workflowExecutionInfo)==null?void 0:Q.taskQueue),x=(z=t==null?void 0:t.workflowExecutionInfo)==null?void 0:z.mostRecentWorkerVersionStamp,q=(D=t==null?void 0:t.workflowExecutionInfo)==null?void 0:D.assignedBuildId,W=(U=t==null?void 0:t.workflowExecutionInfo)==null?void 0:U.parentNamespaceId,T=(L=t==null?void 0:t.workflowExecutionInfo)==null?void 0:L.parentExecution,A=t.workflowExecutionInfo.stateTransitionCount,nt=(j=t.executionConfig)==null?void 0:j.defaultWorkflowTaskTimeout,rt=Pt(t.pendingActivities),at=(t==null?void 0:t.pendingChildren)??[],st=Rt(t==null?void 0:t.pendingNexusOperations),it=t==null?void 0:t.pendingWorkflowTask,ct=Nt(t==null?void 0:t.callbacks);return{name:n,id:r,runId:a,startTime:s,endTime:i,executionTime:c,status:l,historyEvents:d,historySizeBytes:f,searchAttributes:o,memo:e,url:h,taskQueue:k,assignedBuildId:q,mostRecentWorkerVersionStamp:x,pendingActivities:rt,pendingChildren:at,pendingNexusOperations:st,pendingWorkflowTask:it,callbacks:ct,parentNamespaceId:W,parent:T,stateTransitionCount:A,isRunning:u,defaultWorkflowTaskTimeout:nt,get canBeTerminated(){return u&&kt()}}},F=t=>(t.executions||[]).map(o=>N({workflowExecutionInfo:o})),Ot=(t,o)=>{var e;return((e=t==null?void 0:t.visibilityStore)==null?void 0:e.includes("elasticsearch"))||_(o,"1.19")},$t=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},O=y([E],([t])=>{var o,e,n;return(n=(e=(o=t.data)==null?void 0:o.settings)==null?void 0:e.runtimeEnvironment)==null?void 0:n.isCloud}),Z=y([J,R,O],([t,o,e])=>Ot(t,o)||e);y([J,O],([t,o])=>$t(t)||o);const qt={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Vt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Bt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Qt=t=>{if(typeof t!="string")return!1;for(const o of Vt)if(o===t)return!0;return!1},zt=(t,o,e)=>{const n=qt[t];return o==="All"?"":Wt(o)||Tt(o)?e||g(Z)?`${n} > "${K(o)}"`:`${n} BETWEEN "${K(o)}" AND "${At()}"`:`${n}="${o}"`},Dt=(t,o)=>Object.entries(t).map(([e,n])=>{if(Qt(e)&&Bt(n))return zt(e,n,o)}).filter(Boolean),Ut=(t,o=!1)=>Dt(t,o).join(" and ");function Lt(t){console.error("Unhandled action:",t)}const jt=(t,o)=>{let e;switch(t){case b.Cancel:e=I("workflows.canceled");break;case b.Reset:e=I("workflows.reset");break;case b.Terminate:e=I("workflows.terminated");break;default:Lt(t)}return o?I("workflows.workflow-action-reason-placeholder-with-email",{action:e,email:o}):I("workflows.workflow-action-reason-placeholder",{action:e})},tt=({action:t,reason:o,email:e})=>{const n=jt(t,e);return o?[o.trim(),n].join(" "):n};var Ht=Kt;function Kt(t,o,e){var n=null,r=null,a=e&&e.leading,s=e&&e.trailing;a==null&&(a=!0),s==null&&(s=!a),a==!0&&(s=!1);var i=function(){n&&(clearTimeout(n),n=null)},c=function(){var u=r;i(),u&&u()},l=function(){var u=a&&!n,d=this,f=arguments;if(r=function(){return t.apply(d,f)},n||(n=setTimeout(function(){if(n=null,s)return r()},o)),u)return u=!1,r()};return l.cancel=i,l.flush=c,l}const ot=t=>!St(t)||t==="descending"?"events.descending":t==="ascending"?"events.ascending":"events.descending",Fo=async({namespace:t,workflowId:o,runId:e,sort:n,onStart:r,onUpdate:a,onComplete:s})=>{const i=ot(n),c=m(i,{namespace:t,workflowId:o});return(await Y(async u=>w(c,{token:u,request:fetch,params:{"execution.runId":e}}),{onStart:r,onUpdate:a,onComplete:s})).history.events},_t=Ht(()=>{X.set(Date.now())},5e3),Oo=async({namespace:t,workflowId:o,runId:e,sort:n="ascending",signal:r,historySize:a})=>{const s=()=>{r&&H.set([])},i=(h,k)=>{var W,T;if(!r)return;H.set([...C((W=h.history)==null?void 0:W.events)]);const x=(T=k==null?void 0:k.history)==null?void 0:T.events;a&&(x==null?void 0:x.every(A=>parseInt(A.eventId)>parseInt(a)))&&_t()},c=()=>{r&&X.set(Date.now())},l=ot(n),u=m(l,{namespace:t,workflowId:o}),d=await Y(async h=>w(u,{token:h,request:fetch,params:{"execution.runId":e,waitNewEvent:r?"true":"false"},options:{signal:r}}),{onStart:s,onUpdate:i,onComplete:c});return d!=null&&d.history?await C(d.history.events):[]},Gt=async({namespace:t,workflowId:o,runId:e,sort:n,maximumPageSize:r="20"})=>{const a=m(`events.${n}`,{namespace:t,workflowId:o});try{return(await w(a,{request:fetch,params:{maximumPageSize:r,"execution.runId":e}})).history.events}catch{return[]}},Jt=async t=>{const o=await Gt({...t,sort:"ascending",maximumPageSize:"1"});return(await C(o))[0]},$=async(t,o,e=fetch,n=!1)=>{const r=o.query||Ut(o,n);let a;try{a=decodeURIComponent(r)}catch{a=r}const s=n?"workflows.archived":"workflows";let i="";const c=f=>{var h,k;pt(f),(h=f==null?void 0:f.body)!=null&&h.message||f!=null&&f.status?i=((k=f==null?void 0:f.body)==null?void 0:k.message)??`Error fetching workflows: ${f.status}: ${f.statusText}`:i="Error fetching workflows: Server failed to respond"},l=m(s,{namespace:t}),{executions:u,nextPageToken:d}=await w(l,{params:{query:a},onError:c,handleError:c,request:e})??{executions:[],nextPageToken:""};return{workflows:F({executions:u}),nextPageToken:String(d),error:i}},$o=async({namespace:t,workflowId:o,url:e},n=fetch)=>{var u;const r="workflows",a=e??gt(t),s=Et(r,{namespace:t}),i=a+s,{executions:c}=await w(i,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:n})??{executions:[]},l=(u=F({executions:c}))==null?void 0:u[0];return{runId:l==null?void 0:l.runId}},qo=async(t,o=fetch,e=!1)=>{const n=e?"workflows.archived":"workflows";let r=!0;const a=i=>{(xt(i)||It(i))&&(r=!1)},s=m(n,{namespace:t});return await w(s,{params:{pageSize:"1"},onError:a,handleError:a,request:o}),{authorized:r}},Vo=async(t,o,e=fetch)=>$(t,o,e,!0);async function Bo(t,o=fetch){const e=m("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(e,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(n=>({workflow:N(n)})).catch(n=>({error:n}))}async function Qo({workflow:t,namespace:o,reason:e}){const n=m("workflow.terminate",{namespace:o,workflowId:t.id}),r=g(P).email,a=tt({reason:e,action:b.Terminate,email:r});return await w(n,{options:{method:"POST",body:v({reason:a,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function zo({namespace:t,workflow:{id:o,runId:e}},n=fetch){const r=m("workflow.cancel",{namespace:t,workflowId:o});return w(r,{request:n,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":e}})}async function Do({namespace:t,workflow:{id:o,runId:e},name:n,input:r}){const a=m("workflow.signal",{namespace:t,workflowId:o,signalName:n}),s=await M(r),i=g(E).data.settings,c=(i==null?void 0:i.version)??"",u=_(c,"2.22")?{signalName:n,workflowExecution:{workflowId:o,runId:e},input:{payloads:s}}:{signalName:n,input:{payloads:s},params:{"execution.runId":e}};return w(a,{notifyOnError:!1,options:{method:"POST",body:v(u)}})}async function Uo({namespace:t,workflow:{id:o,runId:e},eventId:n,reason:r,reapplyType:a}){const s=m("workflow.reset",{namespace:t,workflowId:o}),i=g(P).email,c=tt({action:b.Reset,reason:r,email:i}),l={workflowExecution:{workflowId:o,runId:e},workflowTaskFinishEventId:n,resetReapplyType:a,requestId:Ct(),reason:c};return w(s,{notifyOnError:!1,options:{method:"POST",body:v(l)},params:{"execution.runId":e}})}async function Lo(t,o=fetch){const e=r=>{console.error(r)},n=m("workflow",t);return w(n,{request:o,onError:e,handleError:e}).then(N)}async function jo(t,o,e){if(!g(et))return[];try{let n=`ParentWorkflowId = "${o}"`;e&&(n+=` AND ParentRunId = "${e}"`);const{workflows:r}=await $(t,{query:n});return r}catch{return[]}}const Mt=t=>{if(!t.length)return{};const o={};return t.forEach(e=>{o[e.attribute]=vt(e.value)}),o};async function Ho({namespace:t,workflowId:o,taskQueue:e,workflowType:n,input:r,searchAttributes:a}){const s=m("workflow",{namespace:t,workflowId:o});let i;if(r)try{i=await M(r)}catch{console.error("Could not decode input for starting workflow")}const c=v({workflowId:o,taskQueue:{name:e},workflowType:{name:n},input:i?{payloads:i}:null,searchAttributes:a.length===0?null:{indexedFields:{...Mt(a)}}});return w(s,{notifyOnError:!1,options:{method:"POST",body:c}})}const Ko=async({namespace:t,workflowType:o,workflowId:e})=>{var a,s,i;const n=c=>{console.error(c)},r={input:"",searchAttributes:void 0};try{let c="";o&&e?c=`WorkflowType = "${o}" AND WorkflowId = "${e}"`:o?c=`WorkflowType = "${o}"`:e&&(c=`WorkflowId = "${e}"`);const l=m("workflows",{namespace:t}),u=await w(l,{params:{query:c,pageSize:"1"},handleError:n});if(!((a=u==null?void 0:u.executions)!=null&&a[0]))return r;const d=F(u)[0],h=await Jt({namespace:t,workflowId:d.id,runId:d.runId}),k=await dt((s=h==null?void 0:h.attributes)==null?void 0:s.input,t,g(E).data.settings,g(P).accessToken);return{input:v(k==null?void 0:k.payloads[0]),searchAttributes:(i=d==null?void 0:d.searchAttributes)==null?void 0:i.indexedFields}}catch{return r}},Xt=300,Yt=async(t,o,e)=>{o.set(!0);try{await e()}catch(n){console.error(n)}t.set(!1),setTimeout(()=>{o.set(!1)},Xt)},Zt=y([E],([t])=>{var o,e,n;return!!((n=(e=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:e.capabilities)!=null&&n.countGroupByExecutionStatus)}),_o=y([E,R],([t,o])=>{var r,a,s;const e=G("1.23.0",o),n=!!((s=(a=(r=t.data)==null?void 0:r.systemInfo)==null?void 0:a.capabilities)!=null&&s.prefixSearch);return e||n}),to=p(0),oo=y([E],([t])=>{var o,e;return(e=(o=t.data)==null?void 0:o.settings)==null?void 0:e.hideWorkflowQueryErrors}),et=y([O,R],([t,o])=>t||G("1.23.0",o)),eo=y([E],([t])=>t.url.searchParams.get("query")),no=y([eo,et,bt],([t,o,e])=>o&&!e?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),ro=y([E],([t])=>t.params.namespace),ao=y([ro,no,to,Z,oo],([t,o,e,n,r])=>({namespace:t,query:o,refresh:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})),so=t=>{lo.set({...t,newCount:0})},io=t=>ao.subscribe(({namespace:o,query:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})=>{Yt(uo,co,async()=>{const{workflows:a,error:s}=await $(o,{query:e});if(t(a),n&&!g(Zt)){const i=await lt(o,e);so(i)}s?r?S.set(I("workflows.workflows-error-querying")):S.set(s):S.set("")})}),Go=p(""),co=p(!0),uo=p(!0),lo=p({count:0,newCount:0}),S=p(""),Jo=ut([],io),Mo=p("");export{Jo as A,uo as B,co as C,S as D,qo as a,Oo as b,zo as c,jo as d,Ko as e,$o as f,lo as g,Vo as h,Ut as i,Uo as j,Do as k,Bo as l,Lo as m,Zt as n,Fo as o,Mo as p,no as q,to as r,Ho as s,Qo as t,jt as u,O as v,Go as w,Z as x,_o as y,et as z};
