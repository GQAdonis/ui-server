import{d,r as nt,w as g}from"./entry.iL_WIb7k.js";import{p as E}from"./stores.JXkdxER0.js";import{t as p}from"./translate.HrioCK44.js";import{a as rt}from"./workflow-counts.VGL2LXpo.js";import{C as x}from"./scheduler.tl3rb73C.js";import{A as I}from"./workflow-actions.-K4W_iAA.js";import{e as at,c as it}from"./decode-payload.wNd8Jh65.js";import{f as st,g as ct,h as lt}from"./screaming-enums.6mdiatB1.js";import{w as ft}from"./write-actions-are-allowed.KtuE1vQH.js";import{s as ut}from"./index.SyN40dvV.js";import{a as T}from"./auth-user.DGJ1tx8Y.js";import{i as U,m as D}from"./version-check.HLZIw2tw.js";import{c as L,t as A}from"./versions.0uCoBTKV.js";import{s as dt}from"./filters.yaPOjUDL.js";import{e as j,s as wt}from"./encode-payload.HeLcpcti.js";import{b as mt,p as kt,a as w,r as m,c as ht,d as yt,e as xt}from"./route-for-api.6-i9W_TA.js";import{s as b}from"./parse-with-big-int.e3oI4SEy.js";import{i as Et,c as gt,t as z,d as pt}from"./format-time.kIGiWi1Q.js";import{a as It}from"./events-service.oHOLylDX.js";import{v as bt}from"./toaster.Bwi81Ja4.js";const Wt=(t=[])=>t.map(o=>{const e=ut(o,!0),n=o.activityId;return{...e,id:n}}),Tt=t=>t?t.map(o=>({...o,state:ct(o.state)})):[],At=t=>t?t.map(o=>({...o,state:lt(o.state)})):[],St=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((e,[n,r])=>({...e,[n]:at(r)}),{})},S=t=>{var v,F,N,$,V,q,B,Q;const o=St(t.workflowExecutionInfo.searchAttributes),e=t.workflowExecutionInfo.memo,n=t.workflowExecutionInfo.type.name,r=t.workflowExecutionInfo.execution.workflowId,a=t.workflowExecutionInfo.execution.runId,s=t.workflowExecutionInfo.startTime,i=t.workflowExecutionInfo.closeTime,c=t.workflowExecutionInfo.executionTime,f=st(t.workflowExecutionInfo.status),u=f==="Running",k=t.workflowExecutionInfo.historyLength,l=t.workflowExecutionInfo.historySizeBytes,h=`/workflows/${r}/${a}`,y=((F=(v=t==null?void 0:t.executionConfig)==null?void 0:v.taskQueue)==null?void 0:F.name)||((N=t==null?void 0:t.workflowExecutionInfo)==null?void 0:N.taskQueue),R=($=t==null?void 0:t.workflowExecutionInfo)==null?void 0:$.mostRecentWorkerVersionStamp,H=(V=t==null?void 0:t.workflowExecutionInfo)==null?void 0:V.assignedBuildId,J=(q=t==null?void 0:t.workflowExecutionInfo)==null?void 0:q.parentNamespaceId,M=(B=t==null?void 0:t.workflowExecutionInfo)==null?void 0:B.parentExecution,X=t.workflowExecutionInfo.stateTransitionCount,Y=(Q=t.executionConfig)==null?void 0:Q.defaultWorkflowTaskTimeout,Z=Wt(t.pendingActivities),tt=(t==null?void 0:t.pendingChildren)??[],ot=Tt(t==null?void 0:t.pendingNexusOperations),et=At(t==null?void 0:t.callbacks);return{name:n,id:r,runId:a,startTime:s,endTime:i,executionTime:c,status:f,historyEvents:k,historySizeBytes:l,searchAttributes:o,memo:e,url:h,taskQueue:y,assignedBuildId:H,mostRecentWorkerVersionStamp:R,pendingActivities:Z,pendingChildren:tt,pendingNexusOperations:ot,callbacks:et,parentNamespaceId:J,parent:M,stateTransitionCount:X,isRunning:u,defaultWorkflowTaskTimeout:Y,get canBeTerminated(){return u&&ft()}}},C=t=>(t.executions||[]).map(o=>S({workflowExecutionInfo:o})),Ct=(t,o)=>{var e;return((e=t==null?void 0:t.visibilityStore)==null?void 0:e.includes("elasticsearch"))||U(o,"1.19")},Pt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},P=d([E],([t])=>{var o,e,n;return(n=(e=(o=t.data)==null?void 0:o.settings)==null?void 0:e.runtimeEnvironment)==null?void 0:n.isCloud}),K=d([L,A,P],([t,o,e])=>Ct(t,o)||e);d([L,P],([t,o])=>Pt(t)||o);const Ot={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Rt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],vt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Ft=t=>{if(typeof t!="string")return!1;for(const o of Rt)if(o===t)return!0;return!1},Nt=(t,o,e)=>{const n=Ot[t];return o==="All"?"":Et(o)||gt(o)?e||x(K)?`${n} > "${z(o)}"`:`${n} BETWEEN "${z(o)}" AND "${pt()}"`:`${n}="${o}"`},$t=(t,o)=>Object.entries(t).map(([e,n])=>{if(Ft(e)&&vt(n))return Nt(e,n,o)}).filter(Boolean),Vt=(t,o=!1)=>$t(t,o).join(" and ");function qt(t){console.error("Unhandled action:",t)}const Bt=(t,o)=>{let e;switch(t){case I.Cancel:e=p("workflows.canceled");break;case I.Reset:e=p("workflows.reset");break;case I.Terminate:e=p("workflows.terminated");break;default:qt(t)}return o?p("workflows.workflow-action-reason-placeholder-with-email",{action:e,email:o}):p("workflows.workflow-action-reason-placeholder",{action:e})},_=({action:t,reason:o,email:e})=>{const n=Bt(t,e);return o?[o.trim(),n].join(" "):n},O=async(t,o,e=fetch,n=!1)=>{const r=o.query||Vt(o,n);let a;try{a=decodeURIComponent(r)}catch{a=r}const s=n?"workflows.archived":"workflows";let i="";const c=l=>{var h,y;ht(l),(h=l==null?void 0:l.body)!=null&&h.message||l!=null&&l.status?i=((y=l==null?void 0:l.body)==null?void 0:y.message)??`Error fetching workflows: ${l.status}: ${l.statusText}`:i="Error fetching workflows: Server failed to respond"},f=m(s,{namespace:t}),{executions:u,nextPageToken:k}=await w(f,{params:{query:a},onError:c,handleError:c,request:e})??{executions:[],nextPageToken:""};return{workflows:C({executions:u}),nextPageToken:String(k),error:i}},po=async({namespace:t,workflowId:o,url:e},n=fetch)=>{var u;const r="workflows",a=e??mt(t),s=kt(r,{namespace:t}),i=a+s,{executions:c}=await w(i,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:n})??{executions:[]},f=(u=C({executions:c}))==null?void 0:u[0];return{runId:f==null?void 0:f.runId}},Io=async(t,o=fetch,e=!1)=>{const n=e?"workflows.archived":"workflows";let r=!0;const a=i=>{(yt(i)||xt(i))&&(r=!1)},s=m(n,{namespace:t});return await w(s,{params:{pageSize:"1"},onError:a,handleError:a,request:o}),{authorized:r}},bo=async(t,o,e=fetch)=>O(t,o,e,!0);async function Wo(t,o=fetch){const e=m("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(e,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(n=>({workflow:S(n)})).catch(n=>({error:n}))}async function To({workflow:t,namespace:o,reason:e}){const n=m("workflow.terminate",{namespace:o,workflowId:t.id}),r=x(T).email,a=_({reason:e,action:I.Terminate,email:r});return await w(n,{options:{method:"POST",body:b({reason:a,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Ao({namespace:t,workflow:{id:o,runId:e}},n=fetch){const r=m("workflow.cancel",{namespace:t,workflowId:o});return w(r,{request:n,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":e}})}async function So({namespace:t,workflow:{id:o,runId:e},name:n,input:r}){const a=m("workflow.signal",{namespace:t,workflowId:o,signalName:n}),s=await j(r),i=x(E).data.settings,c=(i==null?void 0:i.version)??"",u=U(c,"2.22")?{signalName:n,workflowExecution:{workflowId:o,runId:e},input:{payloads:s}}:{signalName:n,input:{payloads:s},params:{"execution.runId":e}};return w(a,{notifyOnError:!1,options:{method:"POST",body:b(u)}})}async function Co({namespace:t,workflow:{id:o,runId:e},eventId:n,reason:r,reapplyType:a}){const s=m("workflow.reset",{namespace:t,workflowId:o}),i=x(T).email,c=_({action:I.Reset,reason:r,email:i}),f={workflowExecution:{workflowId:o,runId:e},workflowTaskFinishEventId:n,resetReapplyType:a,requestId:bt(),reason:c};return w(s,{notifyOnError:!1,options:{method:"POST",body:b(f)},params:{"execution.runId":e}})}async function Po(t,o=fetch){const e=r=>{console.error(r)},n=m("workflow",t);return w(n,{request:o,onError:e,handleError:e}).then(S)}async function Oo(t,o,e){if(!x(G))return[];try{let n=`ParentWorkflowId = "${o}"`;e&&(n+=` AND ParentRunId = "${e}"`);const{workflows:r}=await O(t,{query:n});return r}catch{return[]}}const Qt=t=>{if(!t.length)return{};const o={};return t.forEach(e=>{o[e.attribute]=wt(e.value)}),o};async function Ro({namespace:t,workflowId:o,taskQueue:e,workflowType:n,input:r,searchAttributes:a}){const s=m("workflow",{namespace:t,workflowId:o});let i;if(r)try{i=await j(r)}catch{console.error("Could not decode input for starting workflow")}const c=b({workflowId:o,taskQueue:{name:e},workflowType:{name:n},input:i?{payloads:i}:null,searchAttributes:a.length===0?null:{indexedFields:{...Qt(a)}}});return w(s,{notifyOnError:!1,options:{method:"POST",body:c}})}const vo=async({namespace:t,workflowType:o,workflowId:e})=>{var a,s,i;const n=c=>{console.error(c)},r={input:"",searchAttributes:void 0};try{let c="";o&&e?c=`WorkflowType = "${o}" AND WorkflowId = "${e}"`:o?c=`WorkflowType = "${o}"`:e&&(c=`WorkflowId = "${e}"`);const f=m("workflows",{namespace:t}),u=await w(f,{params:{query:c,pageSize:"1"},handleError:n});if(!((a=u==null?void 0:u.executions)!=null&&a[0]))return r;const k=C(u)[0],h=await It({namespace:t,workflowId:k.id,runId:k.runId}),y=await it((s=h==null?void 0:h.attributes)==null?void 0:s.input,t,x(E).data.settings,x(T).accessToken);return{input:b(y==null?void 0:y.payloads[0]),searchAttributes:(i=k==null?void 0:k.searchAttributes)==null?void 0:i.indexedFields}}catch{return r}},zt=300,Ut=async(t,o,e)=>{o.set(!0);try{await e()}catch(n){console.error(n)}t.set(!1),setTimeout(()=>{o.set(!1)},zt)},Dt=d([E],([t])=>{var o,e,n;return!!((n=(e=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:e.capabilities)!=null&&n.countGroupByExecutionStatus)}),Fo=d([E,A],([t,o])=>{var r,a,s;const e=D("1.23.0",o),n=!!((s=(a=(r=t.data)==null?void 0:r.systemInfo)==null?void 0:a.capabilities)!=null&&s.prefixSearch);return e||n}),Lt=g(0),jt=d([E],([t])=>{var o,e;return(e=(o=t.data)==null?void 0:o.settings)==null?void 0:e.hideWorkflowQueryErrors}),G=d([P,A],([t,o])=>t||D("1.23.0",o)),Kt=d([E],([t])=>t.url.searchParams.get("query")),_t=d([Kt,G,dt],([t,o,e])=>o&&!e?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),Gt=d([E],([t])=>t.params.namespace),Ht=d([Gt,_t,Lt,K,jt],([t,o,e,n,r])=>({namespace:t,query:o,refresh:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})),Jt=t=>{Zt.set({...t,newCount:0})},Mt=t=>Ht.subscribe(({namespace:o,query:e,supportsAdvancedVisibility:n,hideWorkflowQueryErrors:r})=>{Ut(Yt,Xt,async()=>{const{workflows:a,error:s}=await O(o,{query:e});if(t(a),n&&!x(Dt)){const i=await rt(o,e);Jt(i)}s?r?W.set(p("workflows.workflows-error-querying")):W.set(s):W.set("")})}),No=g(""),Xt=g(!0),Yt=g(!0),Zt=g({count:0,newCount:0}),W=g(""),$o=nt([],Mt),Vo=g("");export{Xt as A,W as B,Io as a,Oo as b,Ao as c,vo as d,Zt as e,po as f,bo as g,Vt as h,Co as i,So as j,Wo as k,Po as l,Dt as m,Vo as n,Bt as o,P as p,_t as q,Lt as r,Ro as s,To as t,K as u,Fo as v,No as w,G as x,$o as y,Yt as z};
