import{d as y,r as lt,w as p}from"./entry.-1IYhCcN.js";import{p as g}from"./stores.2Qfao90k.js";import{t as I}from"./translate.HrioCK44.js";import{v as j,H as E}from"./scheduler.OdTyv_h4.js";import{r as m,a as d,i as _,c as ft,p as dt,d as wt,e as mt,f as ht,m as Y}from"./route-for-api.oc3m08kk.js";import{A as b}from"./workflow-actions.-K4W_iAA.js";import{b as kt,c as yt}from"./decode-payload.8kQq9PF0.js";import{f as Et,g as gt,h as pt}from"./screaming-enums.6mdiatB1.js";import{s as xt,c as J,t as P}from"./versions.s_G5NWZ5.js";import{s as It,t as C}from"./index.TbN6oRAG.js";import{a as R}from"./auth-user.FbM4eu-E.js";import{f as K,c as bt}from"./events.BBs3jfLf.js";import{e as M,s as vt}from"./encode-payload.IocJn8qM.js";import{s as v}from"./parse-with-big-int.jPY5aC0s.js";import{k as Wt,l as Tt,m as G,n as St}from"./format-time.SD8Sj6b-.js";import{r as X}from"./workflow-run.oa5uGb9i.js";import{m as At}from"./has.xJw2Cu5K.js";import{p as Z}from"./paginated._78yhgNO.js";import{v as Ct}from"./toaster.6Arvsp4K.js";const Pt=async(t,o,n=fetch)=>{let e=0;try{const r=m("workflows.count",{namespace:t}),s=await d(r,{params:o?{query:o}:{},onError:j,handleError:j,request:n});e=parseInt((s==null?void 0:s.count)||"0")}catch{}return{count:e}},Oo=async({namespace:t,query:o})=>{const n="GROUP BY ExecutionStatus",e=m("workflows.count",{namespace:t}),{count:r,groups:s}=await d(e,{params:{query:o?`${o} ${n}`:`${n}`},notifyOnError:!1});return{count:r??"0",groups:s}},$o=async({namespace:t})=>{const o='TemporalNamespaceDivision="TemporalScheduler" AND ExecutionStatus="Running"',n=m("workflows.count",{namespace:t}),{count:e}=await d(n,{params:{query:o},notifyOnError:!1});return e??"0"},Rt=(t=xt)=>!E(t).disableWriteActions,Nt=(t=[])=>t.map(o=>{const n=It(o,!0),e=o.activityId;return{...n,id:e}}),Ot=t=>t?t.map(o=>({...o,state:gt(o.state)})):[],$t=t=>t?t.map(o=>({...o,state:pt(o.state)})):[],Ft=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((n,[e,r])=>({...n,[e]:kt(r)}),{})},N=t=>{var B,V,D,Q,z,U,L,H;const o=Ft(t.workflowExecutionInfo.searchAttributes),n=t.workflowExecutionInfo.memo,e=t.workflowExecutionInfo.type.name,r=t.workflowExecutionInfo.execution.workflowId,s=t.workflowExecutionInfo.execution.runId,a=t.workflowExecutionInfo.startTime,i=t.workflowExecutionInfo.closeTime,c=t.workflowExecutionInfo.executionTime,l=Et(t.workflowExecutionInfo.status),u=l==="Running",w=t.workflowExecutionInfo.historyLength,f=t.workflowExecutionInfo.historySizeBytes,h=`/workflows/${r}/${s}`,k=((V=(B=t==null?void 0:t.executionConfig)==null?void 0:B.taskQueue)==null?void 0:V.name)||((D=t==null?void 0:t.workflowExecutionInfo)==null?void 0:D.taskQueue),x=(Q=t==null?void 0:t.workflowExecutionInfo)==null?void 0:Q.mostRecentWorkerVersionStamp,q=(z=t==null?void 0:t.workflowExecutionInfo)==null?void 0:z.assignedBuildId,W=(U=t==null?void 0:t.workflowExecutionInfo)==null?void 0:U.parentNamespaceId,T=(L=t==null?void 0:t.workflowExecutionInfo)==null?void 0:L.parentExecution,S=t.workflowExecutionInfo.stateTransitionCount,rt=(H=t.executionConfig)==null?void 0:H.defaultWorkflowTaskTimeout,st=Nt(t.pendingActivities),at=(t==null?void 0:t.pendingChildren)??[],it=Ot(t==null?void 0:t.pendingNexusOperations),ct=t==null?void 0:t.pendingWorkflowTask,ut=$t(t==null?void 0:t.callbacks);return{name:e,id:r,runId:s,startTime:a,endTime:i,executionTime:c,status:l,historyEvents:w,historySizeBytes:f,searchAttributes:o,memo:n,url:h,taskQueue:k,assignedBuildId:q,mostRecentWorkerVersionStamp:x,pendingActivities:st,pendingChildren:at,pendingNexusOperations:it,pendingWorkflowTask:ct,callbacks:ut,parentNamespaceId:W,parent:T,stateTransitionCount:S,isRunning:u,defaultWorkflowTaskTimeout:rt,get canBeTerminated(){return u&&Rt()}}},O=t=>(t.executions||[]).map(o=>N({workflowExecutionInfo:o})),qt=(t,o)=>{var n;return((n=t==null?void 0:t.visibilityStore)==null?void 0:n.includes("elasticsearch"))||_(o,"1.19")},Bt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},$=y([g],([t])=>{var o,n,e;return(e=(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:e.isCloud}),tt=y([J,P,$],([t,o,n])=>qt(t,o)||n);y([J,$],([t,o])=>Bt(t)||o);const Vt={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Dt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Qt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),zt=t=>{if(typeof t!="string")return!1;for(const o of Dt)if(o===t)return!0;return!1},Ut=(t,o,n)=>{const e=Vt[t];return o==="All"?"":Wt(o)||Tt(o)?n||E(tt)?`${e} > "${G(o)}"`:`${e} BETWEEN "${G(o)}" AND "${St()}"`:`${e}="${o}"`},Lt=(t,o)=>Object.entries(t).map(([n,e])=>{if(zt(n)&&Qt(e))return Ut(n,e,o)}).filter(Boolean),Ht=(t,o=!1)=>Lt(t,o).join(" and ");function jt(t){console.error("Unhandled action:",t)}const Kt=(t,o)=>{let n;switch(t){case b.Cancel:n=I("workflows.canceled");break;case b.Reset:n=I("workflows.reset");break;case b.Terminate:n=I("workflows.terminated");break;default:jt(t)}return o?I("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:o}):I("workflows.workflow-action-reason-placeholder",{action:n})},ot=({action:t,reason:o,email:n})=>{const e=Kt(t,n);return o?[o.trim(),e].join(" "):e};var Gt=_t;function _t(t,o,n){var e=null,r=null,s=n&&n.leading,a=n&&n.trailing;s==null&&(s=!0),a==null&&(a=!s),s==!0&&(a=!1);var i=function(){e&&(clearTimeout(e),e=null)},c=function(){var u=r;i(),u&&u()},l=function(){var u=s&&!e,w=this,f=arguments;if(r=function(){return t.apply(w,f)},e||(e=setTimeout(function(){if(e=null,a)return r()},o)),u)return u=!1,r()};return l.cancel=i,l.flush=c,l}const nt=t=>!At(t)||t==="descending"?"events.descending":t==="ascending"?"events.ascending":"events.descending",Fo=async({namespace:t,workflowId:o,runId:n,sort:e,onStart:r,onUpdate:s,onComplete:a})=>{const i=nt(e),c=m(i,{namespace:t,workflowId:o});return(await Z(async u=>d(c,{token:u,request:fetch,params:{"execution.runId":n}}),{onStart:r,onUpdate:s,onComplete:a})).history.events},Yt=Gt(()=>{X.set(Date.now())},5e3),qo=async({namespace:t,workflowId:o,runId:n,sort:e="ascending",signal:r,historySize:s})=>{const a=()=>{r&&K.set([])},i=(h,k)=>{var W,T;if(!r)return;K.set([...C((W=h.history)==null?void 0:W.events)]);const x=(T=k==null?void 0:k.history)==null?void 0:T.events;s&&(x==null?void 0:x.every(S=>parseInt(S.eventId)>parseInt(s)))&&Yt()},c=()=>{r&&X.set(Date.now())},l=nt(e),u=m(l,{namespace:t,workflowId:o}),w=await Z(async h=>d(u,{token:h,request:fetch,params:{"execution.runId":n,waitNewEvent:r?"true":"false"},options:{signal:r}}),{onStart:a,onUpdate:i,onComplete:c});return w!=null&&w.history?await C(w.history.events):[]},Jt=async({namespace:t,workflowId:o,runId:n,sort:e,maximumPageSize:r="20"})=>{const s=m(`events.${e}`,{namespace:t,workflowId:o});try{return(await d(s,{request:fetch,params:{maximumPageSize:r,"execution.runId":n}})).history.events}catch{return[]}},Mt=async t=>{const o=await Jt({...t,sort:"ascending",maximumPageSize:"1"});return(await C(o))[0]},F=async(t,o,n=fetch,e=!1)=>{const r=o.query||Ht(o,e);let s;try{s=decodeURIComponent(r)}catch{s=r}const a=e?"workflows.archived":"workflows";let i="";const c=f=>{var h,k;wt(f),(h=f==null?void 0:f.body)!=null&&h.message||f!=null&&f.status?i=((k=f==null?void 0:f.body)==null?void 0:k.message)??`Error fetching workflows: ${f.status}: ${f.statusText}`:i="Error fetching workflows: Server failed to respond"},l=m(a,{namespace:t}),{executions:u,nextPageToken:w}=await d(l,{params:{query:s},onError:c,handleError:c,request:n})??{executions:[],nextPageToken:""};return{workflows:O({executions:u}),nextPageToken:String(w),error:i}},Bo=async({namespace:t,workflowId:o,url:n},e=fetch)=>{var u;const r="workflows",s=n??ft(t),a=dt(r,{namespace:t}),i=s+a,{executions:c}=await d(i,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:e})??{executions:[]},l=(u=O({executions:c}))==null?void 0:u[0];return{runId:l==null?void 0:l.runId}},Vo=async(t,o=fetch,n=!1)=>{const e=n?"workflows.archived":"workflows";let r=!0;const s=i=>{(mt(i)||ht(i))&&(r=!1)},a=m(e,{namespace:t});return await d(a,{params:{pageSize:"1"},onError:s,handleError:s,request:o}),{authorized:r}},Do=async(t,o,n=fetch)=>F(t,o,n,!0);async function Qo(t,o=fetch){const n=m("workflow",{namespace:t.namespace,workflowId:t.workflowId});return d(n,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(e=>({workflow:N(e)})).catch(e=>({error:e}))}async function zo({workflow:t,namespace:o,reason:n}){const e=m("workflow.terminate",{namespace:o,workflowId:t.id}),r=E(R).email,s=ot({reason:n,action:b.Terminate,email:r});return await d(e,{options:{method:"POST",body:v({reason:s,...r&&{identity:r}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Uo({namespace:t,workflow:{id:o,runId:n}},e=fetch){const r=m("workflow.cancel",{namespace:t,workflowId:o});return d(r,{request:e,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Lo({namespace:t,workflow:{id:o,runId:n},name:e,input:r}){const s=m("workflow.signal",{namespace:t,workflowId:o,signalName:e}),a=await M(r),i=E(g).data.settings,c=(i==null?void 0:i.version)??"",u=_(c,"2.22")?{signalName:e,workflowExecution:{workflowId:o,runId:n},input:{payloads:a}}:{signalName:e,input:{payloads:a},params:{"execution.runId":n}};return d(s,{notifyOnError:!1,options:{method:"POST",body:v(u)}})}async function Ho({namespace:t,workflow:{id:o,runId:n},eventId:e,reason:r,reapplyType:s}){const a=m("workflow.reset",{namespace:t,workflowId:o}),i=E(R).email,c=ot({action:b.Reset,reason:r,email:i}),l={workflowExecution:{workflowId:o,runId:n},workflowTaskFinishEventId:e,resetReapplyType:s,requestId:Ct(),reason:c};return d(a,{notifyOnError:!1,options:{method:"POST",body:v(l)},params:{"execution.runId":n}})}async function jo(t,o=fetch){const n=r=>{console.error(r)},e=m("workflow",t);return d(e,{request:o,onError:n,handleError:n}).then(N)}async function Ko(t,o,n){if(!E(et))return[];try{let e=`ParentWorkflowId = "${o}"`;n&&(e+=` AND ParentRunId = "${n}"`);const{workflows:r}=await F(t,{query:e});return r}catch{return[]}}const Xt=t=>{if(!t.length)return{};const o={};return t.forEach(n=>{o[n.attribute]=vt(n.value)}),o};async function Go({namespace:t,workflowId:o,taskQueue:n,workflowType:e,input:r,searchAttributes:s}){const a=m("workflow",{namespace:t,workflowId:o});let i;if(r)try{i=await M(r)}catch{console.error("Could not decode input for starting workflow")}const c=v({workflowId:o,taskQueue:{name:n},workflowType:{name:e},input:i?{payloads:i}:null,searchAttributes:s.length===0?null:{indexedFields:{...Xt(s)}}});return d(a,{notifyOnError:!1,options:{method:"POST",body:c}})}const _o=async({namespace:t,workflowType:o,workflowId:n})=>{var s,a,i;const e=c=>{console.error(c)},r={input:"",searchAttributes:void 0};try{let c="";o&&n?c=`WorkflowType = "${o}" AND WorkflowId = "${n}"`:o?c=`WorkflowType = "${o}"`:n&&(c=`WorkflowId = "${n}"`);const l=m("workflows",{namespace:t}),u=await d(l,{params:{query:c,pageSize:"1"},handleError:e});if(!((s=u==null?void 0:u.executions)!=null&&s[0]))return r;const w=O(u)[0],h=await Mt({namespace:t,workflowId:w.id,runId:w.runId}),k=await yt((a=h==null?void 0:h.attributes)==null?void 0:a.input,t,E(g).data.settings,E(R).accessToken);return{input:v(k==null?void 0:k.payloads[0]),searchAttributes:(i=w==null?void 0:w.searchAttributes)==null?void 0:i.indexedFields}}catch{return r}},Zt=300,to=async(t,o,n)=>{o.set(!0);try{await n()}catch(e){console.error(e)}t.set(!1),setTimeout(()=>{o.set(!1)},Zt)},oo=y([g],([t])=>{var o,n,e;return!!((e=(n=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:n.capabilities)!=null&&e.countGroupByExecutionStatus)}),Yo=y([g,P],([t,o])=>{var r,s,a;const n=Y("1.23.0",o),e=!!((a=(s=(r=t.data)==null?void 0:r.systemInfo)==null?void 0:s.capabilities)!=null&&a.prefixSearch);return n||e}),no=p(0),eo=y([g],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.hideWorkflowQueryErrors}),et=y([$,P],([t,o])=>t||Y("1.23.0",o)),ro=y([g],([t])=>t.url.searchParams.get("query")),so=y([ro,et,bt],([t,o,n])=>o&&!n?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),ao=y([g],([t])=>t.params.namespace),io=y([ao,so,no,tt,eo],([t,o,n,e,r])=>({namespace:t,query:o,refresh:n,supportsAdvancedVisibility:e,hideWorkflowQueryErrors:r})),co=t=>{wo.set({...t,newCount:0})},uo=t=>io.subscribe(({namespace:o,query:n,supportsAdvancedVisibility:e,hideWorkflowQueryErrors:r})=>{to(fo,lo,async()=>{const{workflows:s,error:a}=await F(o,{query:n});if(t(s),e&&!E(oo)){const i=await Pt(o,n);co(i)}a?r?A.set(I("workflows.workflows-error-querying")):A.set(a):A.set("")})}),Jo=p(""),lo=p(!0),fo=p(!0),wo=p({count:0,newCount:0}),A=p(""),Mo=lt([],uo),Xo=p("");export{tt as A,Yo as B,Xo as C,Kt as D,et as E,Mo as F,fo as G,lo as H,A as I,Vo as a,qo as b,Oo as c,Uo as d,Jo as e,Bo as f,_o as g,Go as h,Ko as i,$o as j,$ as k,Rt as l,Do as m,Ht as n,Ho as o,Lo as p,so as q,no as r,Xt as s,zo as t,Yt as u,Qo as v,wo as w,jo as x,oo as y,Fo as z};
